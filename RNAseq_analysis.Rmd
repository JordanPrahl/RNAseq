---
title: "RNAseq Analysis"
author: "Jordan Prahl"
date: "7/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
BiocManager::install("edgeR")
BiocManager::install("limma")
BiocManager::install("AnnotationDbi")
BiocManager::install("org.Hs.eg.db")
BiocManager::install("umap")
BiocManager::install("ggpubr")
BiocManager::install("Rtsne")
BiocManager::install("M3C")
library(M3C)
library(Rtsne)
library(ggpubr)
library(edgeR)
library(dplyr)
library(tidyverse)
library(limma)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(reshape2)
library(ggplot2)
library(ggfortify)
library(magrittr)
library(tibble)
library(DataCombine)
library(umap)
library(readxl)
```

Reading in the full Z-score data from Steve's analysis, but then I filter it down so it's just a dataframe, with the samples names as the colnames, and zscores as the data (each row being a ensembl_gene_id.
```{r, Dimension Reduction Data Prep}
full_data <- read_excel("202000903_7compar_luhmes_lesion_jp_Results_all.xlsx")

# filter the data, I know there are more efficient ways to do this but I don't care
full_data <- full_data[, grep("^logFC", colnames(full_data), invert = T)]
full_data <- full_data[, grep("^AveExpr", colnames(full_data), invert = T)]
full_data <- full_data[, grep("^t_", colnames(full_data), invert = T)]
full_data <- full_data[, grep("^P.Value", colnames(full_data), invert = T)]
full_data <- full_data[, grep("^adj.P", colnames(full_data), invert = T)]
full_data <- full_data[, grep("^B_", colnames(full_data), invert = T)]
full_data <- full_data[, grep("^name", colnames(full_data), invert = T)]
full_data <- full_data[, grep("^SNCA", colnames(full_data), invert = T)]
full_data <- full_data[, grep("^symbol", colnames(full_data), invert = T)]
just_data <- full_data[, grep("^ensembl", colnames(full_data), invert = T)]
```

```{r, PCA}
pca_data <- prcomp(t(just_data), scale. = T)
pData <- data.frame(pca_data$x)

pData$Geno <- c("WT", "WT","WT", "WT","WT", "WT","WT", "WT","WT", "WT","CRISPR_ctrl","CRISPR_ctrl","CRISPR_ctrl","CRISPR_ctrl","CRISPR_ctrl","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","A/-","A/-","A/-","G/-","G/-","G/-","A/G","A/G","A/G")

barplot(pca_data$sdev) # Bar graph of variance
```

``` {r, UMAP}
rna.umap <- umap::umap(t(just_data), n_components=5, scale=T)
uData <- data.frame(rna.umap$layout)

uData$Geno <- c("WT", "WT","WT", "WT","WT", "WT","WT", "WT","WT", "WT","CRISPR_ctrl","CRISPR_ctrl","CRISPR_ctrl","CRISPR_ctrl","CRISPR_ctrl","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","A/-","A/-","A/-","G/-","G/-","G/-","A/G","A/G","A/G")

colnames(uData) <- c("PC1","PC2","PC3","PC4","PC5","Geno")
```
 
```{r, t-SNE}
tsne <- Rtsne(t(dat), perplexity = 5, scale=T, dims = 3) # 3 is the maximum number 

tData <- tsne$Y
tData$Geno <- c("WT", "WT","WT", "WT","WT", "WT","WT", "WT","WT", "WT","CRISPR_ctrl","CRISPR_ctrl","CRISPR_ctrl","CRISPR_ctrl","CRISPR_ctrl","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","Undiff","A/-","A/-","A/-","G/-","G/-","G/-","A/G","A/G","A/G")

colnames(tData) <- c("Geno", "PC1", "PC2", "PC3")
```

```{r, DIMENSIONALITY PLOTS}

{ #START PLOT HERE
     # Choose your dimensions in the xydims vector below.
     # PCA has 33 dimensions, UMAP has 5, and TSNE only has 3 dimensions
  
  xydims <- c(
              "PC2",  # X-Axis
              "PC3",  # Y-axis
              "TSNE"  # Dimension reduction method: UMAP, PCA, or TSNE
              ) 
  
  if(xydims[3]=="UMAP") {data1=uData} else if(xydims[3]=="PCA") {data1=pData} else {data1=tData}
  
  ggplot(data=data1, aes_string(x=noquote(paste0(xydims[1])),y=noquote(paste0(xydims[2])))) +
    geom_point(aes(color = Geno, size=10)) +
    #geom_density2d(alpha=.5) +
    ggtitle(paste0(xydims[3]," of RNAseq data")) +
    xlab(paste0(xydims[1])) + 
    ylab(paste0(xydims[2])) +
    theme_minimal() +
    scale_colour_manual(values=cbPalette)
  
  ggsave(paste0("./plots/",xydims[3],"_figure_",xydims[1],"_",xydims[2],".png"), width = 10, height = 5)

}

```
